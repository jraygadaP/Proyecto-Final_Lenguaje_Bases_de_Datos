
<!---Categoria

CREATE TABLE categoria (
    id_categoria NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, -- Clave primaria con valor autoincremental
    descripcion VARCHAR2(255) NOT NULL,                               -- Descripcion, tipo VARCHAR2
    ruta_imagen VARCHAR2(255),                                        -- Ruta de la imagen, tipo VARCHAR2 (Oracle no tiene un tipo IMG, pero se usa VARCHAR2 para almacenar rutas)
    activo NUMBER(1) DEFAULT 1                                        -- Activo, representado como 1 (true) o 0 (false)
);

SELECT * FROM categoria;

CREATE OR REPLACE PROCEDURE get_Categorias(p_cursor OUT SYS_REFCURSOR) AS
BEGIN
    OPEN p_cursor FOR
    SELECT id_categoria, descripcion, ruta_imagen, activo
    FROM categoria;
END;
/

CREATE OR REPLACE PROCEDURE insert_categoria(
    p_descripcion IN VARCHAR2,
    p_ruta_imagen IN VARCHAR2,
    p_activo IN NUMBER
) AS
BEGIN
    INSERT INTO categoria (descripcion, ruta_imagen, activo)
    VALUES (p_descripcion, p_ruta_imagen, p_activo);
END;
/

CREATE OR REPLACE PROCEDURE update_categoria(
    p_id_categoria IN NUMBER,
    p_descripcion IN VARCHAR2,
    p_ruta_imagen IN VARCHAR2,
    p_activo IN NUMBER
) AS
BEGIN
    UPDATE categoria
    SET descripcion = p_descripcion,
        ruta_imagen = p_ruta_imagen,
        activo = p_activo
    WHERE id_categoria = p_id_categoria;
END;
/

CREATE OR REPLACE PROCEDURE delete_categoria(
    p_id_categoria IN NUMBER
) AS
BEGIN
    DELETE FROM categoria
    WHERE id_categoria = p_id_categoria;
END;
/

--- inventario materiales

CREATE TABLE inventario_materiales (
    id_material NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, -- Clave primaria autoincremental
    tipo_material VARCHAR2(255) NOT NULL,                            -- Tipo de material, VARCHAR2
    cantidad NUMBER                                                  -- Cantidad, tipo NUMBER
);

select * from inventario_materiales


CREATE OR REPLACE PROCEDURE get_inventario_materiales(p_cursor OUT SYS_REFCURSOR) AS
BEGIN
    OPEN p_cursor FOR
    SELECT id_material, tipo_material, cantidad
    FROM inventario_materiales;
END;
/

CREATE OR REPLACE PROCEDURE insert_inventario_materiales(
    p_tipo_material IN VARCHAR2,
    p_cantidad IN NUMBER
) AS
BEGIN
    INSERT INTO inventario_materiales (tipo_material, cantidad)
    VALUES (p_tipo_material, p_cantidad);
END;
/

CREATE OR REPLACE PROCEDURE update_inventario_materiales(
    p_id_material IN NUMBER,
    p_tipo_material IN VARCHAR2,
    p_cantidad IN NUMBER
) AS
BEGIN
    UPDATE inventario_materiales
    SET tipo_material = p_tipo_material,
        cantidad = p_cantidad
    WHERE id_material = p_id_material;
END;
/

CREATE OR REPLACE PROCEDURE delete_inventario_materiales(
    p_id_material IN NUMBER
) AS
BEGIN
    DELETE FROM inventario_materiales
    WHERE id_material = p_id_material;
END;
/


--- Producto


CREATE TABLE producto (
    id_producto NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,  -- Clave primaria autoincremental
    id_categoria NUMBER NOT NULL,                                     -- Clave foránea de categoría
    id_material NUMBER NOT NULL,                                      -- Clave foránea de material
    descripcion VARCHAR2(255) NOT NULL,                               -- Descripción del producto
    detalle VARCHAR2(500),                                            -- Detalle del producto
    precio NUMBER(10, 2),                                             -- Precio del producto
    existencia NUMBER,                                                -- Cantidad en existencia
    ruta_imagen VARCHAR2(255),                                        -- Ruta de la imagen
    activo NUMBER(1) DEFAULT 1,                                       -- Activo: 1 (true) o 0 (false)
    
    CONSTRAINT fk_categoria FOREIGN KEY (id_categoria) REFERENCES categoria(id_categoria),
    CONSTRAINT fk_material FOREIGN KEY (id_material) REFERENCES inventario_materiales(id_material)
);


select * from producto;

CREATE OR REPLACE PROCEDURE get_productos(p_cursor OUT SYS_REFCURSOR) AS
BEGIN
    OPEN p_cursor FOR
    SELECT id_producto, id_categoria, id_material, descripcion, detalle, precio, existencia, ruta_imagen, activo
    FROM producto;
END;
/

CREATE OR REPLACE PROCEDURE insert_producto(
    p_id_categoria IN NUMBER,
    p_id_material IN NUMBER,
    p_descripcion IN VARCHAR2,
    p_detalle IN VARCHAR2,
    p_precio IN NUMBER,
    p_existencia IN NUMBER,
    p_ruta_imagen IN VARCHAR2,
    p_activo IN NUMBER
) AS
BEGIN
    INSERT INTO producto (id_categoria, id_material, descripcion, detalle, precio, existencia, ruta_imagen, activo)
    VALUES (p_id_categoria, p_id_material, p_descripcion, p_detalle, p_precio, p_existencia, p_ruta_imagen, p_activo);
END;
/

CREATE OR REPLACE PROCEDURE update_producto(
    p_id_producto IN NUMBER,
    p_id_categoria IN NUMBER,
    p_id_material IN NUMBER,
    p_descripcion IN VARCHAR2,
    p_detalle IN VARCHAR2,
    p_precio IN NUMBER,
    p_existencia IN NUMBER,
    p_ruta_imagen IN VARCHAR2,
    p_activo IN NUMBER
) AS
BEGIN
    UPDATE producto
    SET id_categoria = p_id_categoria,
        id_material = p_id_material,
        descripcion = p_descripcion,
        detalle = p_detalle,
        precio = p_precio,
        existencia = p_existencia,
        ruta_imagen = p_ruta_imagen,
        activo = p_activo
    WHERE id_producto = p_id_producto;
END;
/


CREATE OR REPLACE PROCEDURE delete_producto(
    p_id_producto IN NUMBER
) AS
BEGIN
    DELETE FROM producto
    WHERE id_producto = p_id_producto;
END;
/


-- seguimiento_promociones

CREATE TABLE seguimiento_promociones (
    id_promociones NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,  -- Clave primaria autoincremental
    id_producto NUMBER NOT NULL,                                         -- Clave foránea de producto
    promocion VARCHAR2(255) NOT NULL,                                    -- Descripción de la promoción
    duracion NUMBER,                                                     -- Duración de la promoción en días
    
    CONSTRAINT fk_producto FOREIGN KEY (id_producto) REFERENCES producto(id_producto)
);

select * from seguimiento_promociones;

CREATE OR REPLACE PROCEDURE get_seguimiento_promociones(p_cursor OUT SYS_REFCURSOR) AS
BEGIN
    OPEN p_cursor FOR
    SELECT id_promociones, id_producto, promocion, duracion
    FROM seguimiento_promociones;
END;
/

CREATE OR REPLACE PROCEDURE insert_seguimiento_promociones(
    p_id_producto IN NUMBER,
    p_promocion IN VARCHAR2,
    p_duracion IN NUMBER
) AS
BEGIN
    INSERT INTO seguimiento_promociones (id_producto, promocion, duracion)
    VALUES (p_id_producto, p_promocion, p_duracion);
END;
/


CREATE OR REPLACE PROCEDURE update_seguimiento_promociones(
    p_id_promociones IN NUMBER,
    p_id_producto IN NUMBER,
    p_promocion IN VARCHAR2,
    p_duracion IN NUMBER
) AS
BEGIN
    UPDATE seguimiento_promociones
    SET id_producto = p_id_producto,
        promocion = p_promocion,
        duracion = p_duracion
    WHERE id_promociones = p_id_promociones;
END;
/


CREATE OR REPLACE PROCEDURE delete_seguimiento_promociones(
    p_id_promociones IN NUMBER
) AS
BEGIN
    DELETE FROM seguimiento_promociones
    WHERE id_promociones = p_id_promociones;
END;
/



--- gestion_proveedor

CREATE TABLE gestion_proveedores (
    id_gestion NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_proveedor NUMBER NOT NULL,                                       -- Clave foránea
    id_material NUMBER NOT NULL,                                       -- Clave foránea de material
    
    CONSTRAINT fk_proveedor_proveedor FOREIGN KEY (id_proveedor) REFERENCES proveedores(id_proveedor),
    CONSTRAINT fk_material_proveedor FOREIGN KEY (id_material) REFERENCES inventario_materiales(id_material)
);



CREATE OR REPLACE PROCEDURE get_gestion_proveedores(p_cursor OUT SYS_REFCURSOR) AS
BEGIN
    OPEN p_cursor FOR
    SELECT id_gestion, id_proveedor, id_material FROM gestion_proveedores;
END;
/



CREATE OR REPLACE PROCEDURE insert_gestion_proveedores(
    p_id_proveedor IN NUMBER,
    p_id_material IN NUMBER
) AS
BEGIN
    INSERT INTO gestion_proveedores (id_proveedor, id_material)
    VALUES (p_id_proveedor, p_id_material);
END;
/



CREATE OR REPLACE PROCEDURE update_gestion_proveedores(
    p_id_gestion IN NUMBER,
    p_id_proveedor IN NUMBER,
    p_id_material IN NUMBER
) AS
BEGIN
    UPDATE gestion_proveedores
    SET id_proveedor = p_id_proveedor,
        id_material = p_id_material
    WHERE id_gestion = p_id_gestion;
END;
/

CREATE OR REPLACE PROCEDURE delete_gestion_proveedores(
    p_id_gestion IN NUMBER
) AS
BEGIN
    DELETE FROM gestion_proveedores
    WHERE id_gestion = p_id_gestion;
END;
/


--- proveedores

CREATE TABLE proveedores (
    id_proveedor NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nombre VARCHAR2(255) NOT NULL
);

select * from proveedores;

CREATE OR REPLACE PROCEDURE get_proveedores (p_cursor OUT SYS_REFCURSOR) AS
BEGIN
    OPEN p_cursor FOR
    SELECT id_proveedor, nombre FROM proveedores;
END;
/



CREATE OR REPLACE PROCEDURE insert_proveedor (
    p_nombre IN VARCHAR2
) AS
BEGIN
    INSERT INTO proveedores (nombre) VALUES (p_nombre);
END;
/

select * from gestion_proveedores

CREATE OR REPLACE PROCEDURE update_proveedor (
    p_id_proveedor IN NUMBER,
    p_nombre IN VARCHAR2
) AS
BEGIN
    UPDATE proveedores
    SET nombre = p_nombre
    WHERE id_proveedor = p_id_proveedor;
END;
/


CREATE OR REPLACE PROCEDURE delete_proveedor (
    p_id_proveedor IN NUMBER
) AS
BEGIN
    DELETE FROM proveedores
    WHERE id_proveedor = p_id_proveedor;
END;
/

-- Usuario
CREATE TABLE usuario (
    id_usuario NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, -- Clave primaria autoincremental
    username VARCHAR2(100) NOT NULL UNIQUE,                        -- Nombre de usuario,  nico
    clave VARCHAR2(255) NOT NULL,                                  -- Contrase a (encriptada o no)
    nombre VARCHAR2(255) NOT NULL,                                 -- Nombre del usuario
    apellido VARCHAR2(255) NOT NULL,                              -- Apellido del usuario
    correo VARCHAR2(255) NOT NULL UNIQUE,                         -- Correo electr nico,  nico
    telefono VARCHAR2(20),                                        -- Tel fono
    ruta_imagen VARCHAR2(255),                                    -- Ruta de la imagen del perfil
    activo NUMBER(1) DEFAULT 1                                    -- Activo: 1 (true) o 0 (false)
);

-- Verificar la tabla
SELECT * FROM usuario;

-- Crear procedimientos para 'usuario'

CREATE OR REPLACE PROCEDURE GET_USUARIOS(p_cursor OUT SYS_REFCURSOR) AS
BEGIN
    OPEN p_cursor FOR
    SELECT id_usuario AS Iden,
           username AS usuario,
           nombre AS nombre,
           correo AS correo
    FROM usuario;
END;
/


-- Insertar un usuario
CREATE OR REPLACE PROCEDURE insert_usuario(
    p_username IN VARCHAR2,
    p_clave IN VARCHAR2,
    p_nombre IN VARCHAR2,
    p_apellido IN VARCHAR2,
    p_correo IN VARCHAR2,
    p_telefono IN VARCHAR2,
    p_ruta_imagen IN VARCHAR2,
    p_activo IN NUMBER
) AS
BEGIN
    INSERT INTO usuario (username, clave, nombre, apellido, correo, telefono, ruta_imagen, activo)
    VALUES (p_username, p_clave, p_nombre, p_apellido, p_correo, p_telefono, p_ruta_imagen, p_activo);
END;
/

-- Actualizar un usuario
CREATE OR REPLACE PROCEDURE update_usuario(
    p_id_usuario IN NUMBER,
    p_username IN VARCHAR2,
    p_clave IN VARCHAR2,
    p_nombre IN VARCHAR2,
    p_apellido IN VARCHAR2,
    p_correo IN VARCHAR2,
    p_telefono IN VARCHAR2,
    p_ruta_imagen IN VARCHAR2,
    p_activo IN NUMBER
) AS
BEGIN
    UPDATE usuario
    SET username = p_username,
        clave = p_clave,
        nombre = p_nombre,
        apellido = p_apellido,
        correo = p_correo,
        telefono = p_telefono,
        ruta_imagen = p_ruta_imagen,
        activo = p_activo
    WHERE id_usuario = p_id_usuario;
END;
/

-- Eliminar un usuario
CREATE OR REPLACE PROCEDURE delete_usuario(
    p_id_usuario IN NUMBER
) AS
BEGIN
    DELETE FROM usuario
    WHERE id_usuario = p_id_usuario;
END;
/

-- Rol
CREATE TABLE rol (
    id_rol NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, -- Clave primaria autoincremental
    id_usuario NUMBER NOT NULL,                                -- Clave for nea de usuario
    nombre VARCHAR2(255) NOT NULL,                            -- Nombre del rol
    
    -- Definir la clave for nea
    CONSTRAINT fk_usuario FOREIGN KEY (id_usuario) REFERENCES usuario(id_usuario)
);

-- Verificar la tabla
SELECT * FROM rol;

-- Obtener todos los roles
CREATE OR REPLACE PROCEDURE get_roles(p_cursor OUT SYS_REFCURSOR) AS
BEGIN
    OPEN p_cursor FOR
    SELECT id_rol, id_usuario, nombre
    FROM rol;
END;
/

-- Insertar un rol
CREATE OR REPLACE PROCEDURE insert_rol(
    p_id_usuario IN NUMBER,
    p_nombre IN VARCHAR2
) AS
BEGIN
    INSERT INTO rol (id_usuario, nombre)
    VALUES (p_id_usuario, p_nombre);
END;
/

-- Actualizar un rol
CREATE OR REPLACE PROCEDURE update_rol(
    p_id_rol IN NUMBER,
    p_id_usuario IN NUMBER,
    p_nombre IN VARCHAR2
) AS
BEGIN
    UPDATE rol
    SET id_usuario = p_id_usuario,
        nombre = p_nombre
    WHERE id_rol = p_id_rol;
END;
/

-- Eliminar un rol
CREATE OR REPLACE PROCEDURE delete_rol(
    p_id_rol IN NUMBER
) AS
BEGIN
    DELETE FROM rol
    WHERE id_rol = p_id_rol;
END;
/

-- Cita
CREATE TABLE cita (
    id_cita NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, -- Clave primaria autoincremental
    id_usuario NUMBER NOT NULL,                                 -- Clave for nea que referencia a usuario
    ruta_imagen VARCHAR2(255),                                  -- Ruta de la imagen relacionada con la cita
    fecha DATE NOT NULL,                                        -- Fecha de la cita
    hora VARCHAR2(8) NOT NULL,                                  -- Hora de la cita (formato HH:MM:SS)
    descripcion VARCHAR2(500),                                  -- Descripci n de la cita
    activo NUMBER(1) DEFAULT 1,                                 -- Activo: 1 (true) o 0 (false)

    CONSTRAINT fk_usuario_cita FOREIGN KEY (id_usuario) REFERENCES usuario(id_usuario)
);

-- Verificar la tabla
SELECT * FROM cita;

-- Crear procedimientos para 'cita'

-- Obtener todas las citas
CREATE OR REPLACE PROCEDURE get_citas(p_cursor OUT SYS_REFCURSOR) AS
BEGIN
    OPEN p_cursor FOR
    SELECT id_cita, id_usuario, ruta_imagen, fecha, hora, descripcion, activo
    FROM cita;
END;
/

-- Insertar una cita
CREATE OR REPLACE PROCEDURE insert_cita(
    p_id_usuario IN NUMBER,
    p_ruta_imagen IN VARCHAR2,
    p_fecha IN DATE,
    p_hora IN VARCHAR2,
    p_descripcion IN VARCHAR2,
    p_activo IN NUMBER
) AS
BEGIN
    INSERT INTO cita (id_usuario, ruta_imagen, fecha, hora, descripcion, activo)
    VALUES (p_id_usuario, p_ruta_imagen, p_fecha, p_hora, p_descripcion, p_activo);
END;
/

-- Actualizar una cita
CREATE OR REPLACE PROCEDURE update_cita(
    p_id_cita IN NUMBER,
    p_id_usuario IN NUMBER,
    p_ruta_imagen IN VARCHAR2,
    p_fecha IN DATE,
    p_hora IN VARCHAR2,
    p_descripcion IN VARCHAR2,
    p_activo IN NUMBER
) AS
BEGIN
    UPDATE cita
    SET id_usuario = p_id_usuario,
        ruta_imagen = p_ruta_imagen,
        fecha = p_fecha,
        hora = p_hora,
        descripcion = p_descripcion,
        activo = p_activo
    WHERE id_cita = p_id_cita;
END;
/

-- Eliminar una cita
CREATE OR REPLACE PROCEDURE delete_cita(
    p_id_cita IN NUMBER
) AS
BEGIN
    DELETE FROM cita
    WHERE id_cita = p_id_cita;
END;
/

-- Gestion_cliente
CREATE TABLE gestion_cliente (
    id_cliente NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, -- Clave primaria autoincremental
    id_usuario NUMBER NOT NULL,                                    -- Clave for nea que referencia a usuario
    nombre VARCHAR2(255) NOT NULL,                                 -- Nombre del cliente
    numero_factura VARCHAR2(50) NOT NULL,                          -- N mero de factura
    correo VARCHAR2(255) NOT NULL,                                 -- Correo electr nico del cliente

    CONSTRAINT fk_usuario_gestion FOREIGN KEY (id_usuario) REFERENCES usuario(id_usuario)
);

-- Verificar la tabla
SELECT * FROM gestion_cliente;

-- Obtener todos los clientes
CREATE OR REPLACE PROCEDURE get_gestion_clientes(p_cursor OUT SYS_REFCURSOR) AS
BEGIN
    OPEN p_cursor FOR
    SELECT id_cliente, id_usuario, nombre, numero_factura, correo
    FROM gestion_cliente;
END;
/

-- Insertar un cliente
CREATE OR REPLACE PROCEDURE insert_gestion_cliente(
    p_id_usuario IN NUMBER,
    p_nombre IN VARCHAR2,
    p_numero_factura IN VARCHAR2,
    p_correo IN VARCHAR2
) AS
BEGIN
    INSERT INTO gestion_cliente (id_usuario, nombre, numero_factura, correo)
    VALUES (p_id_usuario, p_nombre, p_numero_factura, p_correo);
END;
/

-- Actualizar un cliente
CREATE OR REPLACE PROCEDURE update_gestion_cliente(
    p_id_cliente IN NUMBER,
    p_id_usuario IN NUMBER,
    p_nombre IN VARCHAR2,
    p_numero_factura IN VARCHAR2,
    p_correo IN VARCHAR2
) AS
BEGIN
    UPDATE gestion_cliente
    SET id_usuario = p_id_usuario,
        nombre = p_nombre,
        numero_factura = p_numero_factura,
        correo = p_correo
    WHERE id_cliente = p_id_cliente;
END;
/

-- Eliminar un cliente
CREATE OR REPLACE PROCEDURE delete_gestion_cliente(
    p_id_cliente IN NUMBER
) AS
BEGIN
    DELETE FROM gestion_cliente
    WHERE id_cliente = p_id_cliente;
END;
/

-- Devoluciones
CREATE TABLE devoluciones (
    id_devolucion NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, -- Clave primaria autoincremental
    id_cliente NUMBER NOT NULL,                                       -- Clave for nea que referencia a gestion_cliente
    fecha_devolucion DATE NOT NULL,                                   -- Fecha de la devoluci n
    motivo VARCHAR2(500) NOT NULL,                                   -- Motivo de la devoluci n
    estado_devolucion VARCHAR2(50) NOT NULL,                         -- Estado de la devoluci n (Ej: Pendiente, Aceptada, Rechazada)
    

    CONSTRAINT fk_cliente_devolucion FOREIGN KEY (id_cliente) REFERENCES gestion_cliente(id_cliente)
);

-- Verificar la tabla
SELECT * FROM devoluciones;

-- Obtener todas las devoluciones
CREATE OR REPLACE PROCEDURE get_devoluciones(p_cursor OUT SYS_REFCURSOR) AS
BEGIN
    OPEN p_cursor FOR
    SELECT id_devolucion, id_cliente, fecha_devolucion, motivo, estado_devolucion
    FROM devoluciones;
END;
/

-- Insertar una devoluci n
CREATE OR REPLACE PROCEDURE insert_devolucion(
    p_id_cliente IN NUMBER,
    p_fecha_devolucion IN DATE,
    p_motivo IN VARCHAR2,
    p_estado_devolucion IN VARCHAR2
) AS
BEGIN
    INSERT INTO devoluciones (id_cliente, fecha_devolucion, motivo, estado_devolucion)
    VALUES (p_id_cliente, p_fecha_devolucion, p_motivo, p_estado_devolucion);
END;
/

-- Actualizar una devoluci n
CREATE OR REPLACE PROCEDURE update_devolucion(
    p_id_devolucion IN NUMBER,
    p_id_cliente IN NUMBER,
    p_fecha_devolucion IN DATE,
    p_motivo IN VARCHAR2,
    p_estado_devolucion IN VARCHAR2
) AS
BEGIN
    UPDATE devoluciones
    SET id_cliente = p_id_cliente,
        fecha_devolucion = p_fecha_devolucion,
        motivo = p_motivo,
        estado_devolucion = p_estado_devolucion
    WHERE id_devolucion = p_id_devolucion;
END;
/

-- Eliminar una devoluci n
CREATE OR REPLACE PROCEDURE delete_devolucion(
    p_id_devolucion IN NUMBER
) AS
BEGIN
    DELETE FROM devoluciones
    WHERE id_devolucion = p_id_devolucion;
END;
/

-- Empleados
CREATE TABLE empleados (
    id_empleado NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, -- Clave primaria autoincremental
    nombre VARCHAR2(255) NOT NULL,                                   -- Nombre del empleado
    primer_apellido VARCHAR2(255) NOT NULL,                          -- Primer apellido del empleado
    segundo_apellido VARCHAR2(255),                                  -- Segundo apellido del empleado
    puesto VARCHAR2(100) NOT NULL                                    -- Puesto del empleado
);

SELECT * FROM empleados;

-- Crear procedimientos para 'empleados'

-- Obtener todos los empleados
CREATE OR REPLACE PROCEDURE get_empleados(p_cursor OUT SYS_REFCURSOR) AS
BEGIN
    OPEN p_cursor FOR
    SELECT id_empleado, nombre, primer_apellido, segundo_apellido, puesto
    FROM empleados;
END;
/

-- Insertar un empleado
CREATE OR REPLACE PROCEDURE insert_empleado(
    p_nombre IN VARCHAR2,
    p_primer_apellido IN VARCHAR2,
    p_segundo_apellido IN VARCHAR2,
    p_puesto IN VARCHAR2
) AS
BEGIN
    INSERT INTO empleados (nombre, primer_apellido, segundo_apellido, puesto)
    VALUES (p_nombre, p_primer_apellido, p_segundo_apellido, p_puesto);
END;
/

-- Actualizar un empleado
CREATE OR REPLACE PROCEDURE update_empleado(
    p_id_empleado IN NUMBER,
    p_nombre IN VARCHAR2,
    p_primer_apellido IN VARCHAR2,
    p_segundo_apellido IN VARCHAR2,
    p_puesto IN VARCHAR2
) AS
BEGIN
    UPDATE empleados
    SET nombre = p_nombre,
        primer_apellido = p_primer_apellido,
        segundo_apellido = p_segundo_apellido,
        puesto = p_puesto
    WHERE id_empleado = p_id_empleado;
END;
/

-- Eliminar un empleado
CREATE OR REPLACE PROCEDURE delete_empleado(
    p_id_empleado IN NUMBER
) AS
BEGIN
    DELETE FROM empleados
    WHERE id_empleado = p_id_empleado;
END;
/

-- Facturas
CREATE TABLE facturas (
    numero_factura NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,                              -- Clave primaria para la factura
    id_empleado NUMBER NOT NULL,                                    -- Clave for nea que referencia a empleados
    id_usuario NUMBER NOT NULL,                                     -- Clave for nea que referencia a usuarios
    id_producto NUMBER NOT NULL,                                    -- Clave for nea que referencia a productos
    fecha_emision DATE NOT NULL,                                    -- Fecha de emisi n de la factura
    detalle_servicio VARCHAR2(500),                                 -- Detalle del servicio facturado
    
    -- Definir las claves foraneas
    CONSTRAINT fk_factura_empleado FOREIGN KEY (id_empleado) REFERENCES empleados(id_empleado),
    CONSTRAINT fk_factura_usuario FOREIGN KEY (id_usuario) REFERENCES usuario(id_usuario),
    CONSTRAINT fk_factura_producto FOREIGN KEY (id_producto) REFERENCES producto(id_producto)
);

-- Verificar la tabla
SELECT * FROM facturas;

-- Crear procedimientos para 'facturas'

-- Obtener todas las facturas
CREATE OR REPLACE PROCEDURE get_facturas(p_cursor OUT SYS_REFCURSOR) AS
BEGIN
    OPEN p_cursor FOR
    SELECT numero_factura, id_empleado, id_usuario, id_producto, fecha_emision, detalle_servicio
    FROM facturas;
END;
/

-- Insertar una factura
CREATE OR REPLACE PROCEDURE insert_factura(
    p_numero_factura IN NUMBER,
    p_id_empleado IN NUMBER,
    p_id_usuario IN NUMBER,
    p_id_producto IN NUMBER,
    p_fecha_emision IN DATE,
    p_detalle_servicio IN VARCHAR2
) AS
BEGIN
    INSERT INTO facturas (numero_factura, id_empleado, id_usuario, id_producto, fecha_emision, detalle_servicio)
    VALUES (p_numero_factura, p_id_empleado, p_id_usuario, p_id_producto, p_fecha_emision, p_detalle_servicio);
END;
/

-- Actualizar una factura
CREATE OR REPLACE PROCEDURE update_factura(
    p_numero_factura IN NUMBER,
    p_id_empleado IN NUMBER,
    p_id_usuario IN NUMBER,
    p_id_producto IN NUMBER,
    p_fecha_emision IN DATE,
    p_detalle_servicio IN VARCHAR2
) AS
BEGIN
    UPDATE facturas
    SET id_empleado = p_id_empleado,
        id_usuario = p_id_usuario,
        id_producto = p_id_producto,
        fecha_emision = p_fecha_emision,
        detalle_servicio = p_detalle_servicio
    WHERE numero_factura = p_numero_factura;
END;
/

-- Eliminar una factura
CREATE OR REPLACE PROCEDURE delete_factura(
    p_numero_factura IN NUMBER
) AS
BEGIN
    DELETE FROM facturas
    WHERE numero_factura = p_numero_factura;
END;
/

ALTER TABLE cita MODIFY fecha TIMESTAMP;
ALTER TABLE cita MODIFY hora TIMESTAMP;

SET SERVEROUTPUT ON;

DESC usuario;

VARIABLE p_cursor REFCURSOR;

BEGIN
    GET_USUARIOS(:p_cursor);
END;
/

PRINT p_cursor;

ALTER TABLE usuario MODIFY activo DEFAULT 1;

SELECT * FROM gestion_cliente;





--VISTAS

--Inventario Disponible 

CREATE OR REPLACE VIEW vista_inventario_disponible AS
SELECT id_producto, descripcion, existencia 
FROM producto
WHERE existencia > 0;

--Promociones Activas

CREATE OR REPLACE VIEW vista_promociones_activas AS
SELECT p.id_producto, p.descripcion, sp.duracion 
FROM producto p
JOIN seguimiento_promociones sp ON p.id_producto = sp.id_producto
WHERE sp.duracion > CURRENT_DATE;

--Promociones inactivas
CREATE OR REPLACE VIEW vista_promociones_inactivas AS
SELECT p.id_producto, p.descripcion, sp.duracion
FROM producto p
JOIN seguimiento_promociones sp ON p.id_producto = sp.id_producto
WHERE sp.duracion < CURRENT_DATE;

--Citas por Usuario

CREATE OR REPLACE VIEW vista_citas_por_usuario AS
SELECT u.username, c.fecha, c.hora, c.descripcion
FROM usuario u
JOIN cita c ON u.id_usuario = c.id_usuario;

--Productos y Categorias

CREATE OR REPLACE VIEW vista_productos_categorias AS
SELECT p.id_producto, p.descripcion, c.descripcion AS categoria 
FROM producto p
JOIN categoria c ON p.id_categoria = c.id_categoria;

--Devoluciones por cliente

CREATE OR REPLACE VIEW vista_devoluciones_clientes AS
SELECT g.nombre AS cliente, d.fecha_devolucion, d.motivo, d.estado_devolucion 
FROM devoluciones d
JOIN gestion_cliente g ON d.id_cliente = g.id_cliente;

--Productos mas vendidos
CREATE OR REPLACE VIEW vista_productosMas_vendidos AS
SELECT p.id_producto, p.descripcion, SUM(fp.cantidad) AS total
FROM producto p
JOIN factura_producto fp ON p.id_producto = fp.id_producto
GROUP BY p.id_producto, p.descripcion
ORDER BY total DESC;

--Producto sin ventas
CREATE OR REPLACE VIEW vista_productosSin_ventas AS
SELECT p.id_producto, p.descripcion
FROM producto p
LEFT JOIN factura_producto fp ON p.id_producto = fp.id_producto
WHERE fp.id_producto IS NULL;

--Productos bajos de cierta cantidad de stock
CREATE OR REPLACE VIEW vista_productoBajo_stock AS
SELECT id_producto, descripcion, existencia
FROM producto
WHERE existencia < 15;

--Citas ya atendidas
CREATE OR REPLACE VIEW vistas_citas_atendidas AS
SELECT u.username, c.fecha, c.hora, c.descripcion
FROM usuario u
JOIN cita c ON u.id_usuario = c.id_usuario
WHERE C.fecha < CURRENT_DATE;


--FUNCIONES

--Calculo Precio Final

CREATE OR REPLACE FUNCTION calcular_precio_final(
    precio DECIMAL,
    descuento DECIMAL)
RETURN DECIMAL AS
BEGIN
RETURN precio * (1 - descuento);
END;

--Obtener cliente frecuente

CREATE OR REPLACE FUNCTION cliente_frecuente(
    id-cliente INT)
RETURN VARCHAR2 AS
BEGIN
IF (SELECT COUNT (*) FROM facturas WHERE id_cliente = id_cliente) > 10 THEN
RETURN 'CLIENTE FRECUENTE';
ELSE
RETURN 'CLIENTE REGULAR';
END IF;
END;

--Calculo dias para la cita (cuantos faltan)

CREATE OR REPLACE FUNCTION calcular_dias_cita(
    fecha_cita DATE)
RETURN INT AS
BEGIN
RETURN fecha_cita - CURRENT_DATE;
END;

--Cuenta productos en promocion

CREATE OR REPLACE FUNCTION contar_prod_promocion()
RETURN INT AS
BEGIN
RETURN (SELECT COUNT (*)
FROM seguimiento_promociones 
WHERE duracion > CURRENT_DATE);
END;

--Genrerar codigo de factura

CREATE OR REPLACE FUNCTION genera_cod_factura(
    id_factura INT)
RETURN VARCHAR2 AS
BEGIN
RETURN 'F-' || TO_CHAR(SYSDATE, 'YYYYMMDD') || '-' || id_factura;
END;


--Calcular precio con IVA
CREATE OR REPLACE FUNCTION precio_iva(
     precio DECIMAL,
     iva DECIMAL)
RETURN DECIMAL AS
BEGIN
     RETURN precio * (1 + iva);
END;

--Promedio de las ventas por producto
CREATE OR REPLACE FUNCTION promedio_ventasProd(
    id_producto INT)
RETURN DECIMAL AS
BEGIN
     RETURN(SELECT AVG(precio * cantidad)
             FROM factura_producto
             WHERE id_producto = id_producto);
END;

--Nombre producto mas caro
CREATE OR REPLACE FUNCTION producto_caro()
RETURN VARCHAR2 AS
BEGIN 
     RETURN (SELECT descripcion
     FROM producto
     WHERE precio = (SELECT MAX(precio) FROM producto));
END;

--Nombre producto mas barato
CREATE OR REPLACE FUNCTION producto_barato()
RETURN VARCHAR2 AS
BEGIN 
     RETURN (SELECT descripcion
             FROM producto
             WHERE precio = (SELECT MIN(precio) FROM producto));
END;

--Ultima promocion activa
CREATE OR REPLACE FUNCTION ultimaProm_activa()
RETURN DATE AS
BEGIN
     RETURN (SELECT MAX(duracion)
             FROM seguimiento_promociones
             WHERE duracion > CURRENT_DATE);
END;

--Promedio cantidad de productos por factura
CREATE OR REPLACE FUNCTION productos_factura()
RETURN DECIMAL AS
BEGIN
     RETURN(SELECT AVG(cantidad)
            FROM factura_producto);
END;

--Promedio ventas diarias
CREATE OR REPLACE FUNCTION ventas_diarias()
RETURN DECIMAL AS
BEGIN
    RETURN(SELECT AVG(total)
          FROM (SELECT SUM(precio * cantidad) AS total
                FROM facturas
                GROUP BY fecha_emision));
END;

--Total facturas por usuario

CREATE OR REPLACE FUNCTION total_fac_usuario(
    p_id_usuario NUMBER)
RETURN NUMBER AS
BEGIN
     RETURN(SELECT COUNT(*)
            FROM facturas
            WHERE id_usuario = p_id_usuario);
END;

--Materiales por proveedor

CREATE OR REPLACE FUNCTION materiales_por_proveedor(
    p_id_proveedor INT)
RETURN VARCHAR2 AS
    v_materiales VARCHAR2(500); 
BEGIN
    v_materiales := ''; 
    FOR material IN (
        SELECT nombre
        FROM materiales
        WHERE id_proveedor = p_id_proveedor
    ) LOOP
        v_materiales := v_materiales || material.nombre || ', ';
    END LOOP;
    IF LENGTH(v_materiales) > 0 THEN
        v_materiales := SUBSTR(v_materiales, 1, LENGTH(v_materiales) - 2);
    END IF;

    RETURN v_materiales; 
END;

--Fecha ultima compra

CREATE OR REPLACE FUNCTION ultima_compra(
    p_id_cliente NUMBER)
RETURN NUMBER AS
BEGIN
     RETURN(SELECT MAX(fecha_emision)
            FROM facturas
            WHERE id_usuario = p_id_cliente);
END;





-->
